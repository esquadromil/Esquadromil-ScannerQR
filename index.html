<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Esquadromil</title>
<style>
body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: #0e0c1e; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
header { text-align: center; padding: 20px; background: linear-gradient(90deg, #4b0f7c, #e01b23); width: 100%; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
header img { width: 200px; }
header h2 { margin: 10px 0 0 0; font-size: 24px; letter-spacing: 1px; }
main { flex: 1; width: 100%; max-width: 900px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
video { border: 3px solid #e01b23; border-radius: 12px; width: 100%; max-width: 500px; margin-bottom: 15px; }
.buttons { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; color: #fff; transition: transform 0.1s; }
button:hover { transform: scale(1.05); }
#startBtn { background-color: #e01b23; }
#stopBtn { background-color: #4b0f7c; }
#exportBtn { background-color: #6c0a55; }
#clearBtn { background-color: #aa1f40; }
#history { list-style: none; padding: 0; width: 100%; max-width: 500px; }
li { background: #1a1735; margin: 5px 0; padding: 12px; border-radius: 8px; word-break: break-word; display: flex; justify-content: space-between; }
li span { font-weight: bold; }
@media(max-width:600px){ button { flex: 1 1 45%; } }
</style>
</head>
<body>

<header>
    <img src="logobranca.png" alt="Esquadromil Logo">
    <h2>Scanner de QR Codes</h2>
</header>

<main>
    <video id="video" playsinline></video>
    <div class="buttons">
        <button id="startBtn">Iniciar Câmera</button>
        <button id="stopBtn">Parar Câmera</button>
        <button id="exportBtn">Exportar Excel</button>
        <button id="clearBtn">Limpar Histórico</button>
    </div>
    <ul id="history"></ul>
</main>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
const video = document.getElementById('video');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const exportBtn = document.getElementById('exportBtn');
const clearBtn = document.getElementById('clearBtn');
const historyEl = document.getElementById('history');

let codeReader = new ZXing.BrowserQRCodeReader();
let stream;

// Histórico
let scannedCodes = JSON.parse(localStorage.getItem('scannedCodes') || '[]');
updateHistory();

function updateHistory(){
    historyEl.innerHTML = '';
    scannedCodes.forEach(code => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${code}</span>`;
        historyEl.appendChild(li);
    });
    localStorage.setItem('scannedCodes', JSON.stringify(scannedCodes));
}

// Iniciar câmera traseira
startBtn.addEventListener('click', async () => {
    if(stream){
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }

    const constraints = { video: { facingMode: { exact: "environment" } } }; // força traseira

    try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch(e) {
        alert('Câmera traseira não encontrada neste dispositivo.');
        return;
    }

    video.srcObject = stream;
    video.play();

    codeReader.decodeFromVideoDevice(null, video, (result, err) => {
        if(result && !scannedCodes.includes(result.text)){
            scannedCodes.push(result.text);
            updateHistory();
        }
    });
});

// Parar câmera
stopBtn.addEventListener('click', () => {
    if(stream){
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
});

// Exportar Excel
exportBtn.addEventListener('click', () => {
    if(scannedCodes.length === 0){ alert('Nenhum QR Code escaneado!'); return; }
    
    const ws_data = [['QR Code']]; // cabeçalho
    scannedCodes.forEach(code => ws_data.push([code]));
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Scans');
    XLSX.writeFile(wb, 'scanned_codes.xlsx');
});

// Limpar histórico
clearBtn.addEventListener('click', () => {
    if(confirm('Deseja realmente limpar todo o histórico?')){
        scannedCodes = [];
        updateHistory();
    }
});
</script>

</body>
</html>
